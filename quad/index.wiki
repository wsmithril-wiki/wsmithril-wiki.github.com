

== What is this ==

这是一个没有任电路何基础的的人妄想DIY一个四轴飞行器的过程。目前的计划是用Arduino
做飞行控制，遥控部分计划用Wii Chuck。

整个过程遵循一下原则：
# 一边学，一边做
# 不使用任何现成的代码，除了基本的Arduino库，一切自己实现
# 一切以自用为主，不会考虑其他传感器
# 尽量使用模块

项目有关代码全部放在[[|Github]]上。

== 101 ==

以下是我做四轴用到的各部分清单：
- MPU6050 加速度和角速度传感器
- HMC5883L 磁偏角
- BPM085 大气压强
- NRF24L01 无线通信
- 四合一电调一个
- A2212 KV930 无刷电机 * 4
- 1047桨 * 4
- 连接件，机架等
- Dreamer Nano V4.0 * 2
- Wii Chuck
- Arduino <-> Wii Chuck 转换器
- 3.3V - 5V 电平转换模块
- 11.1V Li-po电池一块

传感器模块在选择上都用了提供I2C接口的模块，要不然Arduino的模拟信号输入根本不够用。

== Soft ==

在负责飞行控制的Arduino的主循环中应该包含以下逻辑：

# 读取传感器读数
# 计算当前姿态
# 读取控制信息
# 计算4个电机的输出
# 控制电机

其中除了控制电机何以使用Arduino IDE自带的Servo库，剩下的我都准备自己实现。

控制部分就只需要将Wii Chuch的输出转成控制命令发出1去就行了。

=== 开发环境 ===

推荐在linux使用[[https://github.com/amperka/ino|ino]]，命令行下开发，可以用最习
惯的编辑器而不用Arduino自带的用半残Java写的IDE。这个不知道为什么，在我这里dpi不
正常，菜单栏巨大，编辑器还没有字体平滑。瞎狗眼啊。

ino的使用很简单，基本就是`ino build`编译，`ino upload`上传，`ino serial`从串口读
数据，很是方便。

=== MPU6050 模块 ===

`MPU6050`是一个内置了加速度和角速度传感器的芯片。`I2C`接口，能输出三轴加速度和三
轴角速度，外带一个温度输出，不过不是很准确。芯片内部自带一套算法，能输出经过一定
修正的结果，比较实用。不知道为什么，我的`MPU6050`在在静止时角速度输出结果不为0，
在输出范围为`250° /s`时三轴的漂移为`[450, -940, 250]`，需要在从寄存器读出的结果中
减掉。

=== BPM085 ===

博世出品的大气压强和温度传感器。可以用来测高。不过有一个问题：文档中注明了在向传
感器发出测量温度的指令后，需要等待4.5ms，然后读出温度，再向传感器发出测量大气压
强的指令，然后根据测量精度，等待，最短4.5ms，最长25.5ms，读出气压读数
，再经过一段鬼畜的计后算才能得到真实的读数。等待时间略长，主循环也不应该在等待
读数时得其间内什么都不做，而大气压强也不需要像加速计实时性要求的那么高，所以我用
了另一个策略：CPS。主循环每次先在先调用 `check_data()`，看一下结果准备好了么，如
果没有，就不计算结果；否则就调用`calculate()`把最终结果计算出来。在
`check_data()`内部，会根据记录的当前状态，跳到对应的等待，并且根据`micro()`来
判断是否已经等够了足够的时间，可以读取结果了，否则返回等待结果。用支持词法闭包的
语言能很优雅的实现这种逻辑，用类也能凑或。

估计博世这样设计是为了省电，不请求我就不测量，计算我也不关，想要结果自己算。你是
省电了，我要费这么大劲。对了，还有事先读出12个内建的校正用的仅存器值，给计算用。
加个连续测量模式能死啊。

=== HMC5883L ===

测量磁偏角，连续测量，只需要设置测量精度就行。问题出在计算Heading上。由于磁偏角
传感器本质就是测量流过磁铁的电流，在传感器水平的时候没大问题，






